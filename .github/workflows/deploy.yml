name: Deploy to Production

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest

    steps:
    - name: Execute deployment commands on server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        script: |
          set -e

          # Explicitly source nvm to make node/npm available
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

          # Navigate to the app directory
          cd ${{ secrets.SERVER_PATH }}

          echo "=== Backing up data ==="
          # Clean up any previous failed backup
          rm -rf /tmp/cabin_data_backup

          # Backup untracked/ignored data (live JSON data, logs, uploads)
          mkdir -p /tmp/cabin_data_backup
          if ls data/*.json 1>/dev/null 2>&1; then
            cp data/*.json /tmp/cabin_data_backup/
          fi
          if [ -d "data/logs" ]; then
            cp -R data/logs /tmp/cabin_data_backup/logs
          fi
          if [ -d "data/uploads" ]; then
            cp -R data/uploads /tmp/cabin_data_backup/uploads
          fi

          echo "=== Updating code ==="
          # Force-reset to remote main (avoids merge conflicts from
          # package-lock.json or any server-side file modifications)
          git fetch origin main
          git reset --hard origin/main

          echo "=== Restoring data ==="
          # Restore backed-up data files on top of fresh checkout
          if ls /tmp/cabin_data_backup/*.json 1>/dev/null 2>&1; then
            cp /tmp/cabin_data_backup/*.json data/
          fi
          if [ -d "/tmp/cabin_data_backup/logs" ]; then
            cp -R /tmp/cabin_data_backup/logs data/logs
          fi
          if [ -d "/tmp/cabin_data_backup/uploads" ]; then
            cp -R /tmp/cabin_data_backup/uploads data/uploads
          fi
          rm -rf /tmp/cabin_data_backup

          echo "=== Installing dependencies ==="
          npm install

          echo "=== Generating Prisma client ==="
          npx prisma generate

          echo "=== Running database migrations ==="
          npx prisma migrate deploy

          echo "=== Building frontend ==="
          npm run build

          echo "=== Restarting application ==="
          # Restart PM2 process, or start it if it doesn't exist yet
          pm2 restart chata-app 2>/dev/null || pm2 start npm --name "chata-app" -- run start
          pm2 save

